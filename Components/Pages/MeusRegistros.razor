@page "/meus-registros"
@using GymManager.Data
@using GymManager.Data.Gym
@using GymManager.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject RegistroService Service
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]
@rendermode InteractiveServer
<div class="container">
    <h3>Gerenciar Gym Managers</h3>

    @if (!string.IsNullOrEmpty(mensagem))
    {
        <div class="alert alert-success alert-dismissible fade show">
            @mensagem
            <button type="button" class="btn-close" @onclick="() => mensagem = string.Empty"></button>
        </div>
    }

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">Novo Cadastro</div>
        <div class="card-body">
            <EditForm Model="@NovoRegistro" OnValidSubmit="Salvar" FormName="FormCadastro">
                <DataAnnotationsValidator />
                <div class="row g-3">
                    <div class="col-md-5">
                        <label class="form-label">ID da Academia</label>
                        <InputText @bind-Value="NovoRegistro.IdAcademia" class="form-control" />
                        <ValidationMessage For="@(() => NovoRegistro.IdAcademia)" class="text-danger" />
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Gym ID</label>
                        <InputText @bind-Value="NovoRegistro.GymId" class="form-control" />
                        <ValidationMessage For="@(() => NovoRegistro.GymId)" class="text-danger" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">Salvar</button>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Pesquisar..."
                       @bind="termoPesquisa"
                       @bind:event="oninput"
                       @onkeyup="AoDigitarPesquisa" />
                <button class="btn btn-outline-secondary" @onclick="CarregarDados">
                    <i class="bi bi-search"></i> Pesquisar
                </button>
            </div>
        </div>
    </div>

    <h4>Lista de Registros</h4>

    @if (listaRegistros == null)
    {
        <p>Carregando...</p>
    }
    else if (!listaRegistros.Any())
    {
        <div class="alert alert-info">Nenhum registro encontrado.</div>
    }
    else
    {
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Academia ID</th>
                    <th>Gym ID</th>
                    <th>Criado Por (Email)</th>
                    <th>Status</th>
                    <th>Ações</th>
                    <th>Editar</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in listaRegistros)
                {
                    <tr>
                        <td><strong>@item.IdAcademia</strong></td>
                        <td>@item.GymId</td>
                        <td class="text-muted small">@item.CriadoPorUsuario</td>

                        <td><span class="badge @GetBadgeClass(item.Status)">@item.Status</span></td>

                        <td>
                            @if (ehAdmin)
                            {
                                <select class="form-select form-select-sm" style="width: 130px;"
                                        value="@item.Status"
                                        @onchange="(e) => AtualizarStatus(item, e.Value.ToString())">
                                    @foreach (var s in Enum.GetValues(typeof(EnumStatus)))
                                    {
                                        <option value="@s">@s</option>
                                    }
                                </select>
                            }
                            else
                            {
                                <span class="text-muted" title="Apenas admins podem alterar">
                                    <i></i>Sem permissão
                                </span>
                            }
                        </td>
                        <td>
                            @if (registroEmEdicao == item.Id)
                            {
                                <button class="btn btn-sm btn-success me-1"
                                        @onclick="() => SalvarEdicao(item)">
                                    ✔
                                </button>

                                <button class="btn btn-sm btn-secondary"
                                        @onclick="CancelarEdicao">
                                    ✖
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-primary"
                                        @onclick="() => Editar(item.Id)">
                                    Editar
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <nav aria-label="Paginação">
            <ul class="pagination justify-content-center">
                <li class="page-item @(paginaAtual == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="PaginaAnterior">Anterior</button>
                </li>

                <li class="page-item disabled">
                    <span class="page-link">Página @paginaAtual de @totalPaginas</span>
                </li>

                <li class="page-item @(paginaAtual >= totalPaginas ? "disabled" : "")">
                    <button class="page-link" @onclick="ProximaPagina">Próximo</button>
                </li>
            </ul>
        </nav>
    }
</div>
@code {
    [SupplyParameterFromForm]
    public GymManager NovoRegistro { get; set; }

    private List<GymManager> listaRegistros;
    private int? registroEmEdicao = null;

    private string mensagem = "";
    private string mensagemErro = ""; 
    private bool ehAdmin = false;

    private string termoPesquisa = "";
    private int paginaAtual = 1;
    private int tamanhoPagina = 10;
    private int totalRegistros = 0;

    private int totalPaginas => totalRegistros == 0 ? 1 : (int)Math.Ceiling((double)totalRegistros / tamanhoPagina);

    protected override async Task OnInitializedAsync()
    {
        NovoRegistro ??= new GymManager();

  
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userPrincipal = authState.User;

            if (userPrincipal.Identity is not null && userPrincipal.Identity.IsAuthenticated)
            {
                var userDb = await UserManager.GetUserAsync(userPrincipal);
                if (userDb != null)
                {
                    ehAdmin = userDb.IsAdmin;
                }
            }
        }
        catch
        {
            ehAdmin = false;
        }

        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        var resultado = await Service.ObterPaginadoAsync(termoPesquisa, paginaAtual, tamanhoPagina);

        listaRegistros = resultado.Itens;
        totalRegistros = resultado.TotalRegistros;

        if (paginaAtual > totalPaginas && totalPaginas > 0)
        {
            paginaAtual = 1;
            var resultadoCorrecao = await Service.ObterPaginadoAsync(termoPesquisa, paginaAtual, tamanhoPagina);
            listaRegistros = resultadoCorrecao.Itens;
            totalRegistros = resultadoCorrecao.TotalRegistros;
        }

        StateHasChanged();
    }

    private async Task Salvar()
    {
        mensagem = "";
        mensagemErro = "";

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var usuario = authState.User.Identity?.Name ?? "Anônimo";

        try
        {
            await Service.CriarAsync(NovoRegistro, usuario);

            mensagem = "Salvo com sucesso!";
            NovoRegistro = new GymManager(); 

            paginaAtual = 1;
            termoPesquisa = "";
            await CarregarDados();
        }
        catch (Exception ex)
        {
            mensagemErro = ex.Message;
        }
    }
    private void Editar(int id)
    {
        registroEmEdicao = id;
    }

    private async Task CancelarEdicao()
    {
        registroEmEdicao = null;
        await CarregarDados(); 
    }

    private async Task SalvarEdicao(GymManager item)
    {
        try
        {
            await Service.AtualizaInfo(item.Id, item);

            mensagem = "Registro atualizado com sucesso!";
            registroEmEdicao = null;

            await CarregarDados();
        }
        catch (Exception ex)
        {
            mensagemErro = ex.Message;
        }
    }


    private async Task AtualizarStatus(GymManager item, string novoStatusStr)
    {
        if (!ehAdmin) return;

        if (Enum.TryParse<EnumStatus>(novoStatusStr, out var novoStatus))
        {
            await Service.AtualizarStatusAsync(item.Id, novoStatus);
            item.Status = novoStatus;
        }
    }

    private async Task AtualizarInfo(int id, GymManager item)
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var usuario = authState.User.Identity?.Name ?? "Anônimo";
        await Service.AtualizaInfo(id, item);
    }

    private async Task AoDigitarPesquisa(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            paginaAtual = 1;
            await CarregarDados();
        }
    }

    private async Task PaginaAnterior()
    {
        if (paginaAtual > 1)
        {
            paginaAtual--;
            await CarregarDados();
        }
    }

    private async Task ProximaPagina()
    {
        if (paginaAtual < totalPaginas)
        {
            paginaAtual++;
            await CarregarDados();
        }
    }

    private string GetBadgeClass(EnumStatus s) => s switch
    {
        EnumStatus.Novo => "bg-primary",
        EnumStatus.Progresso => "bg-warning text-dark",
        EnumStatus.Recusado => "bg-danger",
        EnumStatus.Concluido => "bg-success",
        _ => "bg-secondary"
    };
}